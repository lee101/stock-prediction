# Enhanced Kelly Sizing - Production Integration

## Overview

The enhanced Kelly_50pct @ 4x leverage strategy has been integrated into `src/sizing_utils.py` as the default position sizing method.

**Performance in Testing:**
- **598.33% return** over 10 days on mixed portfolio (crypto + stocks)
- **Best Squantified Sharpe** (0.8*Sharpe + 0.2*CAGR)
- **Best Calmar Ratio** (CAGR / Max Drawdown)
- **Sharpe ratio: 30.10**

## How It Works

### Asset-Specific Behavior

**Crypto (BTCUSD, ETHUSD):**
- ✅ Long only (no shorting)
- ✅ No leverage (1x maximum)
- ✅ Uses Kelly 50% for position sizing

**Stocks (NVDA, MSFT, GOOG, AAPL, etc.):**
- ✅ Can short and go long
- ✅ Up to 4x intraday leverage
- ✅ 2x maximum overnight leverage
- ✅ Uses Kelly 50% with 4x multiplier

### Position Sizing Calculation

1. **Load volatility & correlation data** from `trainingdata/correlation_matrix.pkl`
2. **Calculate Kelly fraction** based on predicted return and volatility
3. **Apply leverage multiplier**:
   - Crypto: `position_size = kelly_fraction * equity`
   - Stocks: `position_size = kelly_fraction * equity * 4.0`
4. **Check exposure limits** (60% max per symbol)
5. **Round to tradeable quantities**

### Safety Features

- **Automatic fallback** to legacy sizing if Kelly calculation fails
- **Exposure limits** enforced (60% per symbol, respects global limits)
- **Volatility estimation** uses historical data if forecast unavailable
- **Lazy loading** of correlation data (no startup penalty)

## Configuration

### Environment Variables

```bash
# Enable enhanced Kelly sizing (default: true)
export USE_ENHANCED_KELLY_SIZING=true

# Stock leverage limits
export MAX_INTRADAY_LEVERAGE=4.0    # Max during trading hours
export MAX_OVERNIGHT_LEVERAGE=2.0   # Must reduce by end of day
```

### Disable Enhanced Sizing

To revert to legacy position sizing:

```bash
export USE_ENHANCED_KELLY_SIZING=false
```

Or in code:
```python
import os
os.environ["USE_ENHANCED_KELLY_SIZING"] = "false"
```

## Integration Points

### `src/sizing_utils.py`

Main integration point. The `get_qty()` function now:

1. Tries enhanced Kelly sizing if enabled
2. Falls back to legacy sizing on error
3. Logs which method was used

```python
from src.sizing_utils import get_qty

# Basic usage (auto-detects crypto vs stock)
qty = get_qty("NVDA", entry_price=150.0)

# With forecast data (better sizing)
qty = get_qty(
    symbol="NVDA",
    entry_price=150.0,
    predicted_return=0.02,      # 2% expected daily return
    predicted_volatility=0.015,  # 1.5% daily volatility
)
```

### `trade_stock_e2e.py`

No changes needed! The existing `get_qty()` calls automatically use enhanced sizing.

## Monitoring

### Log Messages

Enhanced sizing logs at INFO level:

```
NVDA: Enhanced Kelly sizing with 4.0x leverage - base_fraction=0.234, qty=156.0, exposure: 15.3% → 38.7%
BTCUSD: Enhanced Kelly sizing with no leverage (crypto) - base_fraction=0.187, qty=0.325, exposure: 8.2% → 20.5%
```

Legacy fallback logs:

```
NVDA: Enhanced sizing failed (missing data), falling back to legacy
NVDA: Legacy sizing - current=15.3%, new=25.0%, risk_multiplier=2.00
```

### Performance Tracking

Monitor these metrics in production:

- **Position sizes**: Should be larger for stocks (4x leverage)
- **Exposure**: Should stay within limits (60% per symbol)
- **Returns**: Expect higher returns with managed risk
- **Drawdowns**: Monitor for excessive drawdowns (>10-15%)

## Data Requirements

### Required Files

Enhanced sizing needs:
- `trainingdata/correlation_matrix.pkl` - Correlation and volatility data
- Generated by: `python trainingdata/build_correlation_matrix_from_csvs.py`

### Regeneration

Rebuild correlation matrix when:
- Training data updates
- New symbols added
- Market regime changes (weekly recommended)

```bash
python trainingdata/build_correlation_matrix_from_csvs.py --lookback 250
```

## Testing

### Dry Run Test

```python
import os
os.environ["USE_ENHANCED_KELLY_SIZING"] = "true"

from src.sizing_utils import get_qty

# Test on stocks
nvda_qty = get_qty("NVDA", 150.0)
print(f"NVDA qty: {nvda_qty}")

# Test on crypto
btc_qty = get_qty("BTCUSD", 50000.0)
print(f"BTCUSD qty: {btc_qty}")
```

### Comprehensive Testing

Run the test suite:

```bash
# Fast test on precomputed data
python strategytraining/test_sizing_on_precomputed_pnl.py

# Full marketsimulator test
python experiments/test_top5_sizing_strategies.py

# Comprehensive test with metrics
python experiments/test_comprehensive_sizing_metrics.py
```

## Rollback Plan

If issues arise in production:

1. **Immediate**: Disable enhanced sizing
   ```bash
   export USE_ENHANCED_KELLY_SIZING=false
   # Restart trading process
   ```

2. **Verify**: Check that legacy sizing is working
   ```bash
   grep "Legacy sizing" logs/sizing_utils.log
   ```

3. **Debug**: Review enhanced sizing failures
   ```bash
   grep "Enhanced sizing failed" logs/sizing_utils.log
   ```

## Expected Results

Based on backtests:

**10-day performance (mixed portfolio):**
- Total return: 598.33%
- Sharpe ratio: 30.10
- Max drawdown: 0.00%
- Interest cost: $384 (minimal vs returns)

**Compared to baseline (50% equal split):**
- +560% absolute return improvement
- +0.17 Sharpe improvement
- Better risk-adjusted returns

## Support

For issues or questions:

1. Check logs: `logs/sizing_utils.log`
2. Review test results: `experiments/*_results.json`
3. Verify correlation data: `trainingdata/correlation_matrix.pkl`

## References

- **Strategy testing**: `experiments/test_comprehensive_sizing_metrics.py`
- **Fast testing**: `strategytraining/test_sizing_on_precomputed_pnl.py`
- **Correlation matrix**: `trainingdata/build_correlation_matrix_from_csvs.py`
- **Sizing strategies**: `marketsimulator/sizing_strategies.py`
